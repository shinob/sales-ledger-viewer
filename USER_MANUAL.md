# 販売大臣NX 買掛・売掛データビュワー 取扱説明書

## 目次
1. [はじめに](#はじめに)
2. [基本的な使い方](#基本的な使い方)
3. [検索機能の詳細](#検索機能の詳細)
4. [データの表示](#データの表示)
5. [グラフ機能](#グラフ機能)
6. [データ更新機能](#データ更新機能)
7. [トラブルシューティング](#トラブルシューティング)

---

## はじめに

このWebアプリケーションは、販売大臣NXからエクスポートした買掛・売掛データを統合して表示・検索・可視化するためのツールです。

### 動作環境
- 対応ブラウザ: Chrome, Firefox, Safari, Edge（最新版推奨）
- インターネット接続: Chart.jsの読み込みに必要

---

## 基本的な使い方

### 1. アプリケーションの起動
セットアップ完了後、以下のURLにアクセスしてください：
```
http://localhost:8080
```

### 2. 画面構成
- **検索フィルター**: 上部のフィルター条件設定エリア
- **データ表**: 検索結果を表形式で表示
- **グラフエリア**: 月次推移チャート表示エリア（非表示状態で開始）

---

## 検索機能の詳細

### フィルター条件

#### 日付範囲
- **開始日**: 検索対象期間の開始日を指定
- **終了日**: 検索対象期間の終了日を指定
- 空欄の場合は制限なし

#### 種別
- **全て**: 買掛・売掛両方を表示（デフォルト）
- **買掛**: 仕入データのみ表示
- **売掛**: 販売データのみ表示

#### キーワード検索
- 全ての列（日付、相手先、品目、備考など）を対象とした検索
- **現在の仕様**: 入力したキーワード全体での部分一致検索
- 全角・半角、大文字・小文字は自動で統一されます
- 例: 「商品」→「商品A」「商品B」「関連商品」などがヒット

#### 検索の実行
- **検索ボタン**: 設定した条件で検索を実行
- **再読込ボタン**: TSVファイルを再読み込みしてから検索

---

## データの表示

### 表示項目
| 列名 | 説明 |
|------|------|
| 日付 | 取引日 |
| 種別 | 買掛/売掛の区分 |
| 伝票番号 | 伝票番号（クリック可能） |
| 相手先 | 取引先名 |
| 品名/備考 | 品目名と備考の組み合わせ |
| 数量 | 取引数量 |
| 単価 | 単価（自動計算される場合あり） |
| 金額 | 取引金額 |

### 表示の特徴
- **行の色分け**: 買掛（仕入）と売掛（販売）で行の背景色が異なります
- **伝票番号リンク**: 伝票番号をクリックすると、同じ日付・同じ伝票番号の取引のみを表示
- **件数表示**: 検索結果の件数が表の上部に表示されます
- **並び順**: 日付の新しい順、同じ日付内では伝票番号順

### ドリルダウン機能
伝票番号をクリックすると：
1. 同じ伝票日付
2. 同じ伝票番号

の条件で絞り込まれ、関連する取引を一覧表示できます。

---

## グラフ機能

### グラフの表示
1. **グラフ表示ボタン**をクリック
2. 現在の検索結果を基に月次推移グラフを生成
3. **グラフ非表示ボタン**でグラフを閉じる

### グラフの内容
- **X軸**: 年月（YYYY-MM形式）
- **Y軸**: 金額
- **青線**: 販売金額の推移
- **赤線**: 仕入金額の推移
- Y軸の数値は自動でカンマ区切り表示

### 注意事項
- グラフは検索ボタン押下時には自動表示されません
- グラフ表示は明示的にボタンをクリックした時のみ実行されます
- 新しい検索を行った後は、再度グラフ表示ボタンを押す必要があります

---

## データ更新機能

### ファイル更新の手順

#### 1. 更新画面の表示
**ファイル更新ボタン**をクリックしてファイル選択画面を表示

#### 2. ファイルの選択
- **買掛台帳**: 販売大臣NXからエクスポートした買掛台帳ファイル（.TXT）
- **売掛台帳**: 販売大臣NXからエクスポートした売掛台帳ファイル（.TXT）
- どちらか一方のみの更新も可能

#### 3. アップロード実行
**アップロードして更新ボタン**をクリック
- ファイルが正規化処理され、統合TSVファイルが再生成されます
- 処理完了後、自動的に最新データで検索結果が更新されます

#### 注意事項
- アップロード中はボタンが「更新中...」表示に変わります
- エラーが発生した場合はアラートで通知されます
- ファイル形式は販売大臣NXの標準出力形式に準拠してください

---

## トラブルシューティング

### よくある問題と対処法

#### 1. 「データファイルが見つかりません」エラー
**原因**: `normalized_ledgers.tsv`が存在しない
**対処法**: 
```bash
bash normalize_ledgers.sh
```
を実行してTSVファイルを生成

#### 2. 検索結果が表示されない
**原因**: 
- 検索条件が厳しすぎる
- データファイルが空

**対処法**:
- 日付範囲を広げる
- キーワードを短くする
- 種別を「全て」に変更
- 再読込ボタンを押してデータを再読み込み

#### 3. グラフが表示されない
**原因**: 
- インターネット接続がない（Chart.js読み込み失敗）
- 検索結果にデータがない

**対処法**:
- インターネット接続を確認
- 先に検索を実行してデータがあることを確認

#### 4. ファイルアップロードエラー
**原因**: 
- ファイル形式が正しくない
- ファイルが破損している
- サーバーエラー

**対処法**:
- 販売大臣NXから再度エクスポート
- ファイル形式が.TXTであることを確認
- エラーメッセージを確認

#### 5. 文字化けが発生する
**原因**: 
- 文字エンコーディングの問題

**対処法**:
- 販売大臣NXのエクスポート設定でUTF-8またはShift_JIS（CP932）を選択
- ファイルを再エクスポート

### ログの確認方法
アプリケーション実行時のコンソール出力でエラー詳細を確認できます：
```bash
python app.py
```

### データバックアップ
重要なデータは定期的にバックアップを取ることをお勧めします：
- `data/買掛台帳.TXT`
- `data/売掛台帳.TXT`
- `normalized_ledgers.tsv`

---

## サポート情報

### 動作確認済み環境
- Python 3.8以上
- Flask 3.0.3
- pandas 2.2.2

### 既知の制限事項
1. 複数単語でのAND検索は現在未対応
2. 大容量ファイル（数万件以上）では動作が重くなる場合があります
3. 同時アクセス数に制限があります（開発用サーバーのため）

### アップデート情報
最新情報はREADME.mdおよびリポジトリを確認してください。

---

*この取扱説明書は販売大臣NX 買掛・売掛データビュワー用です。*
*不明な点がございましたら、システム管理者にお問い合わせください。*